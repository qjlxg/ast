name: è‚¡ç¥¨åˆ†æå·¥ä½œæµ (Stock Analysis Workflow)

on:
  # è§¦å‘å™¨ï¼šç›‘å¬å¯¹æŒ‡å®šæ–‡ä»¶çš„ push æ“ä½œ
  push:
    paths:
      - 'stock_workflow.yml'
      - 'stock_analysis_v2.py'
  
  # ç¤ºä¾‹ï¼šæ¯å¤© UTC æ—¶é—´ 10:00 è¿è¡Œï¼Œç›¸å½“äº CST/GMT+8 (ä¸Šæµ·) æ—¶é—´ 18:00ã€‚
  # schedule:
  #   - cron: '0 10 * * *' 

jobs:
  run_analysis:
    # è®¾ç½®è¿è¡Œç¯å¢ƒä¸ºæœ€æ–°çš„ Ubuntu
    runs-on: ubuntu-latest
    
    # å…³é”®è®¾ç½®ï¼šå°†æ•´ä¸ª Job çš„æ—¶åŒºè®¾ç½®ä¸ºä¸Šæµ·æ—¶é—´
    env:
      TZ: Asia/Shanghai

    steps:
    - name: æ£€å‡ºä»£ç  (Checkout Repository)
      uses: actions/checkout@v4
      # æ³¨æ„ï¼šactions/checkout@v4 é»˜è®¤ä½¿ç”¨ GITHUB_TOKENï¼Œè¯¥ token å…·æœ‰æ¨é€æƒé™ã€‚

    - name: è®¾ç½® Python ç¯å¢ƒ (Set up Python)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' # ç¡®ä¿ä½¿ç”¨å…¼å®¹çš„ Python ç‰ˆæœ¬

    - name: å®‰è£…ä¾èµ– (Install dependencies)
      run: |
        pip install --upgrade pip
        pip install pandas  # ç¡®ä¿å®‰è£…äº† pandas
        echo "ä¾èµ–å®‰è£…æ­¥éª¤å®Œæˆã€‚"

    - name: è¿è¡Œè‚¡ç¥¨åˆ†æè„šæœ¬ (Run Stock Analysis Script)
      run: |
        echo "å·¥ä½œæµå½“å‰è¿è¡Œçš„æ—¶åŒºå’Œæ—¶é—´: $TZ $(date)"
        python stock_analysis_v2.py
        
    # --- æ–°å¢æ­¥éª¤ï¼šæäº¤å¹¶æ¨é€ç»“æœåˆ°ä»“åº“ ---
    - name: æäº¤å¹¶æ¨é€ç»“æœ (Commit and Push Results)
      # ä»…åœ¨è„šæœ¬æˆåŠŸè¿è¡Œåæ‰§è¡Œ
      if: success()
      run: |
        # 1. é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨ GitHub Actions bot èº«ä»½ï¼‰
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 2. æ·»åŠ  buy_signals ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ (æ­¤ç›®å½•åŒ…å«ç”Ÿæˆçš„CSV)
        git add buy_signals
        
        # 3. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹æˆ–æ–°å¢ (é˜²æ­¢ç©ºæäº¤)
        if git diff --cached --exit-code; then
          echo "âœ… ç›®å½• 'buy_signals' ä¸­æ²¡æœ‰æ–°çš„åˆ†æç»“æœï¼Œè·³è¿‡ Git æäº¤ã€‚"
        else
          # 4. æäº¤æ›´æ”¹
          TIMESTAMP=$(date +%Y%m%d%H%M)
          git commit -m "ğŸ¤– Auto: Add/Update stock buy signals for ${TIMESTAMP}"
          
          # 5. æ¨é€åˆ°ä»“åº“ï¼ˆä½¿ç”¨é»˜è®¤çš„ GITHUB_TOKEN æƒé™ï¼‰
          # ä½¿ç”¨ --allow-empty-push ä»¥ç¡®ä¿å³ä½¿æ²¡æœ‰å†…å®¹å˜åŒ–ä¹Ÿèƒ½å®Œæˆæ¨é€ï¼Œä¸è¿‡æˆ‘ä»¬å·²ç»æœ‰diffæ£€æŸ¥äº†ã€‚
          git push
          echo "âœ… å·²å°†æœ€æ–°çš„åˆ†æç»“æœæ¨é€å›ä»“åº“ã€‚"
        fi
