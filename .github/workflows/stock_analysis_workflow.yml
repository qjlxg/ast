name: 数据更新

# 定义触发工作流的事件
on:
  push:
    paths:
      - 'stock_analysis_workflow.yml'
      - 'stock_analysis_all.py'
      - 'progress.txt' # 监控进度文件变化
      
  workflow_dispatch:
  
  schedule:
    - cron: '0 2 * * *'

# 定义工作流中的任务
jobs:
  analyze_stocks:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码 (必须获取完整历史记录和所有文件)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }} 

      # 2. 设置 Python 环境
      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      # 3. 安装依赖和中文字体
      - name: Install dependencies and fonts
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          sudo apt-get install -y gh fonts-wqy-zenhei
          pip install akshare pandas numpy matplotlib tqdm
          
      # 4. 运行股票分析脚本并捕获退出码
      - name: Run stock analysis script (Batch Processing)
        id: run_script
        run: |
          set +e 
          echo "Starting stock analysis script..."
          python stock_analysis_all.py
          EXIT_CODE=$?
          echo "Script finished with exit code: $EXIT_CODE"
          
          echo "status=$EXIT_CODE" >> $GITHUB_OUTPUT
        
      # 5. 【修复推送冲突】将更新的文件提交并推送回仓库
      - name: Commit and push progress and data (Conflict Fix Applied)
        run: |
          # 配置 Git 身份
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add stock_data results progress.txt 
          
          # 检查是否有文件需要提交
          if git diff --staged --quiet; then
            echo "No file changes to commit. Proceeding."
          else
            # 提交更改
            git commit -m "Automated analysis: Save batch progress and data for $(date +%Y-%m-%d) (Exit Code: ${{ steps.run_script.outputs.status }})"
            
            # ------------------------------------------------------------------
            # 【关键修复】: 在推送前拉取远程最新更改并执行 rebase 合并
            # 这解决了并发工作流运行时，当前 Job 本地历史记录落后于远程历史记录的问题。
            git pull --rebase origin HEAD
            # ------------------------------------------------------------------
            
            # 推送
            git push origin HEAD
            echo "Data batch committed and pushed successfully."
          fi
          
      # 6. 检查退出码，如果为 99，则使用 GH CLI 重启工作流
      - name: Check Status and Self-Restart Workflow
        if: steps.run_script.outputs.status == '99'
        run: |
          echo "Exit Code 99 detected: Attempting to restart workflow for next batch..."
          gh workflow run stock_analysis_workflow.yml --ref ${{ github.ref }} || true
          echo "Workflow dispatch process finished."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
