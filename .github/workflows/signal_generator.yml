name: 'ğŸ“Š Daily Buy Signal Generator'

# 1. è§¦å‘æœºåˆ¶
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'd1_signal.py' 
      - '.github/workflows/signal_generator.yml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è¿è¡Œ
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 16:00 è¿è¡Œï¼ˆå¸‚åœºæ”¶ç›˜åï¼‰
    - cron: '0 8 * * *'

# 2. å…¨å±€é…ç½®
env:
  PYTHON_VERSION: '3.10'
  SCRIPT_NAME: 'd1_signal.py'
  DATA_DIR: 'stock_data'
  TZ: 'Asia/Shanghai' 
  
jobs:
  generate_and_push_signals:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: âš™ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. ğŸ”§ å®‰è£…ä¾èµ–ï¼ˆä¿®å¤ TA-Lib å®‰è£…é—®é¢˜ï¼‰
      - name: ğŸ› ï¸ Install TA-Lib and Python packages
        run: |
          # æ›´æ–°å¹¶å®‰è£…ç¼–è¯‘å·¥å…·
          sudo apt-get update
          sudo apt-get install -y build-essential wget
          
          # ä»å¯é çš„é•œåƒä¸‹è½½ TA-Lib
          wget https://downloads.sourceforge.net/project/ta-lib/ta-lib/0.4.0/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          
          # ç¼–è¯‘å’Œå®‰è£… TA-Lib
          cd ta-lib
          ./configure --prefix=/usr
          make
          sudo make install
          cd ..
          
          # å®‰è£… Python ä¾èµ–
          pip install pandas numpy TA-Lib

      # 4. å‡†å¤‡æ•°æ®ç¯å¢ƒ
      - name: ğŸ“‚ Check Data Directory
        run: |
          if [ ! -d "${{ env.DATA_DIR }}" ]; then
            echo "::warning::Data directory '${{ env.DATA_DIR }}' not found. Creating it."
            mkdir -p ${{ env.DATA_DIR }}
          else
            echo "Data directory found with $(ls -1 ${{ env.DATA_DIR }} | wc -l) files"
          fi
          
      # 5. ç”Ÿæˆä¿¡å·
      - name: ğŸš€ Run Signal Generator Script
        id: run_script
        run: |
          # è®¾ç½®æ—¶åŒºå’Œæ—¥æœŸå˜é‡
          export TZ='${{ env.TZ }}'
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          CURRENT_DATE=$(date +'%Y-%m-%d')
          YEAR_MONTH=$(date +'%Y/%m')
          
          echo "Running signal generation script..."
          echo "Current date: $CURRENT_DATE"
          echo "Timestamp: $TIMESTAMP"
          
          # è¿è¡Œè„šæœ¬å¹¶æ•è·è¾“å‡º
          python ${{ env.SCRIPT_NAME }} 2>&1 | tee script_output.log
          
          # æ£€æŸ¥è„šæœ¬æ‰§è¡ŒçŠ¶æ€
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "Script executed successfully"
          else
            echo "Script execution failed"
            exit 1
          fi
          
          # åˆ›å»ºç»“æœæ–‡ä»¶
          RESULT_FILE="signals_${TIMESTAMP}.log"
          echo "Signal Generation Results" > $RESULT_FILE
          echo "=========================" >> $RESULT_FILE
          echo "Generated on: $CURRENT_DATE $TIMESTAMP" >> $RESULT_FILE
          echo "" >> $RESULT_FILE
          cat script_output.log >> $RESULT_FILE
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "RESULT_FILE=$RESULT_FILE" >> $GITHUB_ENV
          echo "TARGET_DIR=$YEAR_MONTH" >> $GITHUB_ENV
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV

      # 6. æ¨é€ç»“æœåˆ°ä»“åº“
      - name: ğŸ“¤ Push Results to Repository
        run: |
          # é…ç½® Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # åˆ›å»ºç›®æ ‡ç›®å½•å¹¶ç§»åŠ¨ç»“æœæ–‡ä»¶
          mkdir -p "${{ env.TARGET_DIR }}"
          mv "${{ env.RESULT_FILE }}" "${{ env.TARGET_DIR }}/"
          
          # æäº¤æ›´æ”¹
          git add "${{ env.TARGET_DIR }}/${{ env.RESULT_FILE }}"
          git commit -m "feat(signals): Add buy signals for ${{ env.CURRENT_DATE }} [skip ci]" || echo "No changes to commit"
          git push