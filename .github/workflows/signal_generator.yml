name: 'üìä Daily Buy Signal Generator'

# 1. Ëß¶ÂèëÊú∫Âà∂
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'd1_signal.py' 
      - '.github/workflows/signal_generator.yml'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®ËøêË°å

# 2. ÂÖ®Â±ÄÈÖçÁΩÆ
env:
  PYTHON_VERSION: '3.10'
  SCRIPT_NAME: 'd1_signal.py'
  DATA_DIR: 'stock_data'
  TZ: 'Asia/Shanghai' 
  
jobs:
  generate_and_push_signals:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ê£ÄÂá∫‰ª£Á†Å
      - name: ‚öôÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. ËÆæÁΩÆ Python ÁéØÂ¢É
      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. ÂÆâË£Ö‰æùËµñ (Â∑≤‰øÆÂ§ç libta-lib-dev Êó†Ê≥ïÂÆö‰ΩçÁöÑÈóÆÈ¢ò)
      - name: üîß Install Dependencies (pandas, ta-lib)
        run: |
          # Á°Æ‰øù universe ‰ªìÂ∫ìÂ∑≤ÂêØÁî®ÔºåËØ•‰ªìÂ∫ìÂåÖÂê´ libta-lib-dev
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y universe

          # ÂÜçÊ¨°Êõ¥Êñ∞Âπ∂ÂÆâË£Ö ta-lib ‰æùËµñÂ∫ì
          sudo apt-get update
          sudo apt-get install -y libta-lib-dev

          # ÂÆâË£Ö Python ÂåÖ
          pip install pandas numpy ta-lib

      # 4. ÂáÜÂ§áÊï∞ÊçÆÁéØÂ¢É
      - name: üìÇ Check Data Directory
        run: |
          if [ ! -d "${{ env.DATA_DIR }}" ]; then
            echo "::warning file=${{ env.DATA_DIR }}::Data directory '${{ env.DATA_DIR }}' not found. Creating it, but you need to ensure data files are present for the script to run correctly."
            mkdir -p ${{ env.DATA_DIR }}
          fi
          
      # 5. ÁîüÊàê‰ø°Âè∑Âπ∂Ê†ºÂºèÂåñÊñá‰ª∂Âêç
      - name: üöÄ Run Signal Generator Script
        id: run_script
        run: |
          # ËÆæÁΩÆÊó∂Âå∫ÂíåÊó•ÊúüÂèòÈáè
          TIMESTAMP=$(TZ='${{ env.TZ }}' date +'%Y%m%d_%H%M%S')
          CURRENT_DATE=$(TZ='${{ env.TZ }}' date +'%Y-%m-%d')
          YEAR_MONTH=$(TZ='${{ env.TZ }}' date +'%Y/%m')
          
          # Ê≥®ÊÑèÔºöËØ∑Á°Æ‰øù d1_signal.py ËÑöÊú¨Â∑≤‰øÆÊîπ‰∏∫Êé•Êî∂ÂëΩ‰ª§Ë°åÂèÇÊï∞ÊàñËá™Âä®Ëé∑ÂèñÂΩìÂâçÊó•Êúü
          # Â¶ÇÊûúËÑöÊú¨‰∏≠‰ªçÊòØÁ°¨ÁºñÁ†ÅÊó•ÊúüÔºåËØ∑ÊâãÂä®‰øÆÊîπÔºöTRADE_DATE = CURRENT_DATE
          
          OUTPUT_TEXT=$(python ${{ env.SCRIPT_NAME }} 2>&1)
          
          # ÂÜôÂÖ•‰∏¥Êó∂ÁªìÊûúÊñá‰ª∂
          RESULT_FILE="${{ github.sha }}.txt"
          echo "Run Date: $CURRENT_DATE" >> $RESULT_FILE
          echo "Signals generated at: $TIMESTAMP" >> $RESULT_FILE
          echo "Full Output:" >> $RESULT_FILE
          echo "$OUTPUT_TEXT" >> $RESULT_FILE

          # ÂÆö‰πâÊúÄÁªàÁõÆÊ†áË∑ØÂæÑÂíåÊñá‰ª∂Âêç
          TARGET_DIR="${YEAR_MONTH}"
          TARGET_FILENAME="signals_${TIMESTAMP}.log"
          
          echo "RESULT_FILE=$RESULT_FILE" >> $GITHUB_ENV
          echo "TARGET_DIR=$TARGET_DIR" >> $GITHUB_ENV
          echo "TARGET_FILENAME=$TARGET_FILENAME" >> $GITHUB_ENV

      # 6. Êé®ÈÄÅÁªìÊûúÂà∞‰ªìÂ∫ì
      - name: üì§ Push Results to Repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat(signals): Add buy signals for ${{ env.TARGET_DIR }} generated at ${{ env.TIMESTAMP }}"
          file_pattern: ${{ env.RESULT_FILE }}
          repository: .
          commit_options: '--allow-empty --no-verify' 
          script: |
            mkdir -p ${{ env.TARGET_DIR }}
            mv ${{ env.RESULT_FILE }} ${{ env.TARGET_DIR }}/${{ env.TARGET_FILENAME }}
            git add ${{ env.TARGET_DIR }}/${{ env.TARGET_FILENAME }}
