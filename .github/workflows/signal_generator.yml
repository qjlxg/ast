name: 'ğŸ“Š Daily Buy Signal Generator'

# 1. è§¦å‘æœºåˆ¶
on:
  push:
    branches:
      - main
      - master
    paths:
      # è„šæœ¬å’Œ YAML æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
      - 'd1_signal.py' 
      - '.github/workflows/signal_generator.yml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è¿è¡Œ

# 2. å…¨å±€é…ç½®
env:
  PYTHON_VERSION: '3.10'
  # è„šæœ¬æ–‡ä»¶å
  SCRIPT_NAME: 'd1_signal.py'
  # æ‚¨çš„æ•°æ®æ–‡ä»¶å¤¹åç§°ï¼ˆå¿…é¡»ä¸è„šæœ¬ä¸­çš„ STOCK_DATA_DIR åŒ¹é…ï¼‰
  DATA_DIR: 'stock_data'
  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œå½±å“ run æ­¥éª¤ä¸­ date å‘½ä»¤çš„è¾“å‡º
  TZ: 'Asia/Shanghai' 
  
jobs:
  generate_and_push_signals:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: âš™ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          # å…è®¸ action æ£€å‡ºåˆ°å·¥ä½œæµè§¦å‘æ—¶çš„ commit
          fetch-depth: 0 

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ”§ Install Dependencies (pandas, ta-lib)
        run: |
          # å®‰è£… ta-lib ä¾èµ–åº“
          sudo apt-get update
          sudo apt-get install -y libta-lib-dev
          
          # å®‰è£… Python åŒ…
          pip install pandas numpy ta-lib

      # 4. å‡†å¤‡æ•°æ®ç¯å¢ƒ
      # æ³¨æ„ï¼šæ­¤æ­¥éª¤å‡è®¾æ‚¨çš„ stock_data ç›®å½•åœ¨ä»“åº“ä¸­ã€‚
      # å¦‚æœæ•°æ®é‡å¤§ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ LFS æˆ–å…¶ä»–æ–¹å¼åœ¨ Action ä¸­ä¸‹è½½æ•°æ®ã€‚
      - name: ğŸ“‚ Check Data Directory
        run: |
          if [ ! -d "${{ env.DATA_DIR }}" ]; then
            echo "::warning file=${{ env.DATA_DIR }}::Data directory '${{ env.DATA_DIR }}' not found. Creating it, but you need to ensure data files are present for the script to run correctly."
            mkdir -p ${{ env.DATA_DIR }}
          fi
          
      # 5. ç”Ÿæˆä¿¡å·å¹¶æ ¼å¼åŒ–æ–‡ä»¶å
      - name: ğŸš€ Run Signal Generator Script
        id: run_script
        run: |
          # è®¾ç½®æ—¶åŒºå’Œæ—¥æœŸå˜é‡
          TIMESTAMP=$(TZ='${{ env.TZ }}' date +'%Y%m%d_%H%M%S')
          CURRENT_DATE=$(TZ='${{ env.TZ }}' date +'%Y-%m-%d')
          YEAR_MONTH=$(TZ='${{ env.TZ }}' date +'%Y/%m')
          
          # è¿è¡Œè„šæœ¬ï¼Œå¹¶è·å–è¾“å‡ºåˆ° RESULT_FILE
          # æ³¨æ„ï¼šè„šæœ¬ä¸­çš„æ—¥æœŸ '2025-10-14' éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ä¸ºæ‚¨æƒ³è¦è¿è¡Œçš„æ—¥æœŸï¼Œ
          # æˆ–è€…åœ¨å®é™…è¿è¡Œå‰ä¿®æ”¹è„šæœ¬ï¼Œä½¿å…¶è‡ªåŠ¨ä½¿ç”¨ CURRENT_DATE å˜é‡ã€‚
          OUTPUT_TEXT=$(python ${{ env.SCRIPT_NAME }} 2>&1)
          
          # æå–æœ€åä¸€è¡Œï¼ˆå‡è®¾è„šæœ¬æœ€åä¸€è¡Œæ˜¯æœ€ç»ˆä¿¡å·åˆ—è¡¨ï¼‰
          SIGNALS=$(echo "$OUTPUT_TEXT" | tail -n 1)
          
          # å†™å…¥ä¸´æ—¶ç»“æœæ–‡ä»¶
          RESULT_FILE="${{ github.sha }}.txt"
          echo "Run Date: $CURRENT_DATE" >> $RESULT_FILE
          echo "Signals generated at: $TIMESTAMP" >> $RESULT_FILE
          echo "Full Output:" >> $RESULT_FILE
          echo "$OUTPUT_TEXT" >> $RESULT_FILE

          # å®šä¹‰æœ€ç»ˆç›®æ ‡è·¯å¾„å’Œæ–‡ä»¶å
          TARGET_DIR="${YEAR_MONTH}"
          TARGET_FILENAME="signals_${TIMESTAMP}.log"
          
          echo "RESULT_FILE=$RESULT_FILE" >> $GITHUB_ENV
          echo "TARGET_DIR=$TARGET_DIR" >> $GITHUB_ENV
          echo "TARGET_FILENAME=$TARGET_FILENAME" >> $GITHUB_ENV

      # 6. æ¨é€ç»“æœåˆ°ä»“åº“
      - name: ğŸ“¤ Push Results to Repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # å¤åˆ¶ç»“æœæ–‡ä»¶åˆ°ç›®æ ‡è·¯å¾„
          commit_message: "feat(signals): Add buy signals for ${{ env.TARGET_DIR }} generated at ${{ env.TIMESTAMP }}"
          file_pattern: ${{ env.RESULT_FILE }}
          repository: . # é»˜è®¤ä½¿ç”¨å½“å‰ä»“åº“
          # ç¡®ä¿æ–‡ä»¶è¢«ç§»åŠ¨åˆ°æ­£ç¡®çš„ç›®å½•
          commit_options: '--allow-empty --no-verify' 
          # å®é™…æ‰§è¡Œç§»åŠ¨å’Œé‡å‘½åï¼Œå¹¶æ¨é€åˆ°æ–°åˆ†æ”¯æˆ–ä¸»åˆ†æ”¯
          # è¿™é‡Œä½¿ç”¨ git å‘½ä»¤æ¥åˆ›å»ºç›®å½•å’Œç§»åŠ¨æ–‡ä»¶
          script: |
            mkdir -p ${{ env.TARGET_DIR }}
            mv ${{ env.RESULT_FILE }} ${{ env.TARGET_DIR }}/${{ env.TARGET_FILENAME }}
            git add ${{ env.TARGET_DIR }}/${{ env.TARGET_FILENAME }}
